# R2P and complexspectrum

# waveform shows DDC output; AI:WF MUST be ?data32? type
# ?data32? ... loks like shorts to me ..

# ${UUT}, ${SITE}
# ${PFX}  eg $HN:1:CH%02d:REF%d:
# ${RS}	  SHORT | LONG
# ${RSS}  SHORT | LONG18
# ${LEN}  waveform LENgth (was size)
# ${FSB}  frequency div eg DDC=16, LIA=128

record(waveform, "${PFX}:Q") {
	field(FLNK, "${UUT}:${SITE}:AI:WF:cplx:${cid}")
}

record(fanout, "${UUT}:${SITE}:AI:WF:cplx:${cid}") {
	field(LNK1, "${PFX}:POLAR")
	field(LNK2, "${UUT}:${SITE}:AI:WF:FOUT")		
	field(FLNK, "${PFX}:PS")
}


# LNK1

# INPA : raw waveform
# INPB : maxcode bits
# INPC : vmax		: ALT: INPC=aslo, INPB=1
# INPD : alarm threshold
# INPO : aoff

record(aSub, "${PFX}:POLAR") {	
	field(SNAM, "cart2pol_${RS}")
	
	field(FTA,  "${RS}")
	field(NOA,  "${LEN}")
	field(INPA, "${PFX}:I")

	field(FTB,  "${RS}")
	field(NOB,  "${LEN}")
	field(INPB, "${PFX}:Q")	

	field(FTVA, "FLOAT")
	field(NOVA, "${LEN}")
	field(DESC, "complex WF in polar A=R B=T")
	
	field(FTVB, "FLOAT")
	field(NOVB, "${LEN}")
	
	field(FLNK, "${UUT}:2:AI:WF:${cid}")
}

record(waveform, "${UUT}:2:AI:WF:${cid}") {
	field(DTYP, "Soft Channel")
	field(FTVL, "FLOAT")
	field(NELM, "${LEN}")
	field(INP,  "${PFX}:POLAR.VALA")
	field(FLNK, "${UUT}:3:AI:WF:${cid}")
	field(DESC, "R value for Site 1")
}

record(waveform, "${UUT}:3:AI:WF:${cid}") {
	field(DTYP, "Soft Channel")
	field(FTVL, "FLOAT")
	field(NELM, "${LEN}")
	field(INP,  "${PFX}:POLAR.VALB")
	field(DESC, "THETA value for Site 1")	
}





# LNK2 : FDDC : only one per site?. 
# This is correct for DDC, and LIA with ONE REF
# With N REFS, there's N of these.

record(calc, "${UUT}:${SITE}:AI:WF:FOUT" ) {
	field(INPA, "${UUT}:0:SIG:CLK_S1:FREQ")
	field(INPB,  "${FSB}")
	field(CALC, "100*FLOOR(A/100)/B")	
	field(DESC,  "Fout from DDC")
}


record(aSub, "${PFX}:PS") {
	field(SNAM, "spectrum_${RSS}")
# I	
	field(FTA,  "${RS}")
	field(NOA,  "${LEN}")
	field(INPA, "${PFX}:I")
# Q
	field(FTB,  "${RS}")	
	field(NOB,  "${LEN}")
	field(INPB, "${PFX}:Q")	
# Fs
	field(FTC,  "FLOAT")
	field(NOC,  "1")
	field(INPC, "${UUT}:${SITE}:AI:WF:FOUT")
# IS CPLX : YES	
	field(FTD,  "ULONG")
	field(NOD,  "1")
	field(INPD, "1")

# single sided power spectrum
	field(FTVA, "FLOAT")
	field(NOVA, "${LEN}")
	field(DESC, "complex PS in polar A=R B=T C=Window")
	
# BINS - 
	field(FTVB, "FLOAT")
	field(NOVB, "${LEN}")
#window		
	field(FTVC,  "FLOAT")
	field(NOVC,  "${LEN}")	
}

alias("${PFX}:PS", "${UUT}:${SITE}:AI:WF:PS:${cid}")
