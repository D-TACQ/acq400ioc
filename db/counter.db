record(bo, "${UUT}:${SITE}:SIG:${lname}:RESET") {
	field(DTYP, "Soft Channel")
}

record(longin, "${UUT}:${SITE}:SIG:${lname}:rawcount") {
	field(SCAN, "${DT} second")
	field(DTYP, "longinAcqHost")
	field(INP,  "@/dev/acq400.${SITE}.knobs/${pname}")
	field(DESC, "CLK STAT ${lname}")	
	field(FLNK, "${UUT}:${SITE}:SIG:${lname}:ACTIVE")
	field(PRIO, "HIGH")
}


record(calc, "${UUT}:${SITE}:SIG:${lname}:ACTIVE") {
	field(INPA, "${UUT}:${SITE}:SIG:${lname}:rawcount")
	field(INPB, "${UUT}:${SITE}:SIG:${lname}:ACTIVE.LA")
	field(INPL, "${CTRMAX}")
	field(CALC, "A:=A<B?L+A:A; (A-B) ? 1: 0")
	field(PREC, "1")
	field(FLNK, "${UUT}:${SITE}:SIG:${lname}:nzcount")
	field(DESC, "True is signal changed from last")
}


record(calcout, "${UUT}:${SITE}:SIG:${lname}:nzcount") {
	field(INPA, "${UUT}:${SITE}:SIG:${lname}:ACTIVE")
	field(DESC, "computes number of active updates")
	field(CALC, "A==0? 0: VAL+1")
	field(FLNK, "${UUT}:${SITE}:SIG:${lname}:rawc64")
}

record(calc, "${UUT}:${SITE}:SIG:${lname}:rawc64") {
	field(INPA, "${UUT}:${SITE}:SIG:${lname}:rawcount")
	field(INPB, "${UUT}:${SITE}:SIG:${lname}:rawc64.LA")
	field(INPC, "${CTRMAX}")
	field(INPD, "${UUT}:${SITE}:SIG:${lname}:ACTIVE")
	field(INPE, "${UUT}:${SITE}:SIG:${lname}:RESET")
	field(CALC, "E? 0: VAL + (A*D!=0?A>=B?(A-B):(A+C-B):0)")
#                    01234567890012345678900123456789001234567890	
	field(FLNK, "${UUT}:${SITE}:SIG:${lname}:COUNT")
	field(DESC, "64 bit count corrects HW rollover")
}

record(calc, "${UUT}:${SITE}:SIG:${lname}:COUNT") {
	field(INPA, "${UUT}:${SITE}:SIG:${lname}:rawc64")
	# C is scale
	field(INPC, "1")
	field(CALC,  "C*A")
	field(FLNK, "${UUT}:${SITE}:SIG:${lname}:delta")
	field(DESC, "64 bit count scaled")
}

record(calc, "${UUT}:${SITE}:SIG:${lname}:delta") {
	field(INPA, "${UUT}:${SITE}:SIG:${lname}:COUNT")
	field(INPB, "${UUT}:${SITE}:SIG:${lname}:delta.LA")
	field(CALC, "(A > B && B != 0 ? A-B: 0)")
	field(DESC, "computes count difference")
	field(FLNK, "${UUT}:${SITE}:SIG:${lname}:filter")	
}

record(calc, "${UUT}:${SITE}:SIG:${lname}:filter") {
	field(INPA, "${UUT}:${SITE}:SIG:${lname}:delta")
	field(INPB, "${UUT}:${SITE}:SIG:${lname}:filter.LA")
	field(INPC, "${UUT}:${SITE}:SIG:${lname}:filter.LB")
	field(INPD, "${UUT}:${SITE}:SIG:${lname}:filter.LC")
	field(INPE, "${UUT}:${SITE}:SIG:${lname}:filter.LD")
	field(INPF, "${UUT}:${SITE}:SIG:${lname}:filter.LE")
	field(INPG, "${UUT}:${SITE}:SIG:${lname}:filter.LF")
	field(INPH, "${UUT}:${SITE}:SIG:${lname}:filter.LG")
	field(INPI, "${UUT}:${SITE}:SIG:${lname}:filter.LH")
	field(INPJ, "${UUT}:${SITE}:SIG:${lname}:filter.LI")
	field(INPK, "${UUT}:${SITE}:SIG:${lname}:filter.LJ")
	field(INPL, "${UUT}:${SITE}:SIG:${lname}:filter.LK")
	field(CALC, "A+B+C+D+E+F+G+H+I+J+K+L")
#                    1234567890123456789012345678901234567890	
	field(DESC, "CLK FREQ ${lname} filter")
	field(FLNK, "${UUT}:${SITE}:SIG:${lname}:smoocount")
}

# reject filter if change > 25%
record(calc, "${UUT}:${SITE}:SIG:${lname}:smoocount") {
	field(INPA, "${UUT}:${SITE}:SIG:${lname}:delta")
	field(INPB, "${UUT}:${SITE}:SIG:${lname}:smoo.LA")	
	field(CALC, "MIN(ABS(A-B)/MIN(A,B)>0.25?1: VAL+1)")
#                    1234567890123456789012345678901234567890	
	field(FLNK, "${UUT}:${SITE}:SIG:${lname}:filcount")
}
# limit filter count to 12 smooth, nz values.
record(calc, "${UUT}:${SITE}:SIG:${lname}:filcount") {
	field(INPK, "${UUT}:${SITE}:SIG:${lname}:smoocount")
	field(INPL, "${UUT}:${SITE}:SIG:${lname}:nzcount")	
	field(CALC, "MIN(MIN(L,K),12)")
#                    1234567890123456789012345678901234567890	
	field(FLNK, "${UUT}:${SITE}:SIG:${lname}:FREQ")
}

record(calc, "${UUT}:${SITE}:SIG:${lname}:FREQ") {
	field(INPA, "${UUT}:${SITE}:SIG:${lname}:delta")
	field(INPB, "${UUT}:${SITE}:SIG:${lname}:filter")	
	field(INPK, "${DTC}")
	field(INPL, "${UUT}:${SITE}:SIG:${lname}:filcount")
	field(CALC, "A==0?0: L<12? A/K: 0.25*B/(L*K)+0.75*VAL")
#                    1234567890123456789012345678901234567890
	field(PREC, "0")
	field(EGU,  "Hz")
	field(DESC, "CLK FREQ ${lname}")
}

