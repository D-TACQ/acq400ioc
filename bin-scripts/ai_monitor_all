#!/bin/sh

PIDF=/var/run/ai_monitor_all.pid
LOG=/var/log/ai_monitor.log

start() {
	/usr/local/bin/procServ \
		-c / -p ${PIDF} -L $LOG \
		2223 \
	/usr/local/bin/ai_monitor_all run_monitor
}

stop() {
        if [ -r ${PIDF} ]; then
                kill -s TERM $(cat ${PIDF})
                rm ${PIDF}
        fi
}
run_monitor() {
	for SX in /dev/acq400.?
	do
		SITE=${SX#*.}
		OPTS=""
		DATA32=$(cat $SX.knobs/data32)
		if [ $DATA32 -eq 1 ]; then
			OPTS="-w 4"
		fi
		NCFILE=/etc/acq400/$SITE/NCHAN
		if [ -e $NCFILE ]; then
			OPTS="$OPTS --nchan $(cat $NCFILE)"
		fi	
		/usr/local/bin/acq400_stream $OPTS --hb0 $SITE &
	done
	
	forsleep update-histo 2>&1 >/dev/null &
	wait;wait;wait
}

trap "pkill -s 0" SIGINT SIGTERM

case "$1" in
run_monitor)
	run_monitor;;
start)
	stop; start;;
stop)
	stop;;
esac


